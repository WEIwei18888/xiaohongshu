import streamlit as st
from streamlit import spinner
from utils_xiaohongshu import generate_copywriting

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(
    page_title="å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨",
    page_icon="ğŸ“",
    layout="wide",
    initial_sidebar_state="expanded"
)

# æ·»åŠ è‡ªå®šä¹‰CSSä»¥ç¡®ä¿è¾“å…¥æ¡†æœ‰è¾¹æ¡†
st.markdown("""
<style>
    .stTextInput > div > div > input {
        border: 1px solid #CCCCCC;
        border-radius: 8px;
        padding: 0.5rem;
    }
</style>
""", unsafe_allow_html=True)

# ä¾§è¾¹æ 
with st.sidebar:
    opneai_api_key = st.text_input("è¯·è¾“å…¥ä½ çš„OpenAI APIå¯†é’¥ï¼š", type="password")
    st.markdown("[è·å–Openai APIå¯†é’¥](https://platform.openai.com/api-keys)")

#åº”ç”¨æ ‡é¢˜
st.title("å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨ âœ¨")
st.write("ç”ŸæˆåŒ…å«5ä¸ªæ ‡é¢˜å’Œå®Œæ•´æ­£æ–‡çš„ç»“æ„åŒ–å°çº¢ä¹¦å†…å®¹")

st.divider()

# é€‰æ‹©å†…å®¹ç±»å‹
content_type = st.radio(
    "é€‰æ‹©å†…å®¹ç±»å‹",
    ["äº§å“æ¨å¹¿", "ç»éªŒæ•™ç¨‹", "æ—…è¡Œæ”»ç•¥", "ç”Ÿæ´»è®°å½•"],
    index=0,
    horizontal=True
)

# å®šä¹‰å„ç±»å‹çš„è¾“å…¥å­—æ®µé…ç½®
form_config = {
    "äº§å“æ¨å¹¿": {
        "fields": ["äº§å“åç§°", "äº§å“ç±»åˆ«", "å–ç‚¹", "ç›®æ ‡äººç¾¤", "ç—›ç‚¹", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "äº§å“åç§°": "ä¾‹å¦‚ï¼šæ¶¦ç™¾é¢œç»å°¿é…¸æ¬¡æŠ›ç²¾å",
            "äº§å“ç±»åˆ«": "ç¾å¦†/æŠ¤è‚¤/ç¾é£Ÿ/ç©¿æ­ç­‰",
            "å–ç‚¹": "ä¿æ¹¿ã€ä¿®å¤ã€ç‹¬ç«‹åŒ…è£…ç­‰",
            "ç›®æ ‡äººç¾¤": "æ²¹çš®/å­¦ç”Ÿå…š/å®å¦ˆ",
            "ç—›ç‚¹": "å¡ç²‰ã€å‡ºæ²¹ã€æ•æ„Ÿç­‰",
            "é£æ ¼è¦æ±‚": "ç§è‰é£/æµ‹è¯„é£/å¹²è´§é£"
        }
    },
    "ç»éªŒæ•™ç¨‹": {
        "fields": ["æ•™ç¨‹ä¸»é¢˜", "ç›®æ ‡äººç¾¤", "å·¥å…·/ææ–™", "æ­¥éª¤è¦ç‚¹", "å¸¸è§é—®é¢˜", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "æ•™ç¨‹ä¸»é¢˜": "ä¾‹å¦‚ï¼š3æ­¥ç”»å¥½æˆªæ–­å¼çœ¼å¦†",
            "ç›®æ ‡äººç¾¤": "æ–°æ‰‹/è¿›é˜¶/ç†Ÿç»ƒ",
            "å·¥å…·/ææ–™": "ç²‰åº•æ£’ã€å§èš•ç¬”ç­‰",
            "æ­¥éª¤è¦ç‚¹": "1. ç²‰åº•æ£’å¿«é€Ÿä¸Šå¦†æŠ€å·§\n2. 3ç¬”æå®šå§èš•",
            "å¸¸è§é—®é¢˜": "å®¹æ˜“æ™•å¦†æ€ä¹ˆåŠï¼Ÿå§èš•ç”»ä¸å¥½ï¼Ÿ",
            "é£æ ¼è¦æ±‚": "ç®€æ´æ˜äº†/å¹½é»˜é£è¶£"
        }
    },
    "æ—…è¡Œæ”»ç•¥": {
        "fields": ["ç›®çš„åœ°", "æ—…è¡Œå¤©æ•°", "å¿…å»æ™¯ç‚¹", "ç¾é£Ÿæ¨è", "å®ç”¨Tips", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "ç›®çš„åœ°": "ä¾‹å¦‚ï¼šé’å²›è€åŸåŒºã€æ–°ç–†ä¼ŠçŠ",
            "æ—…è¡Œå¤©æ•°": "2å¤©1å¤œã€5å¤©4æ™š",
            "å¿…å»æ™¯ç‚¹": "ä¿¡å·å±±ã€å¤§å­¦è·¯ç­‰",
            "ç¾é£Ÿæ¨è": "æœ¬åœ°äººç§è—å’–å•¡é¦†ã€è€å­—å·é¤å…",
            "å®ç”¨Tips": "äº¤é€šæ–¹å¼ã€é—¨ç¥¨é¢„çº¦ã€é¿é›·æé†’",
            "é£æ ¼è¦æ±‚": "æ”»ç•¥å‹/ä½“éªŒå‹/æ‘„å½±æŒ‡å—"
        }
    },
    "ç”Ÿæ´»è®°å½•": {
        "fields": ["ä¸»é¢˜å…³é”®è¯", "åœºæ™¯ç»†èŠ‚", "æ—¶é—´/åœ°ç‚¹", "æƒ…æ„ŸåŸºè°ƒ", "æƒ³ä¼ è¾¾çš„ç‚¹", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "ä¸»é¢˜å…³é”®è¯": "ä¾‹å¦‚ï¼šç‹¬å±…ç”Ÿæ´»ã€æƒ…ä¾£æ—¥å¸¸",
            "åœºæ™¯ç»†èŠ‚": "å‘¨å…­ä¸Šåˆå»èƒ¡åŒå’–å•¡åº—çœ‹ä¹¦çš„ç»†èŠ‚",
            "æ—¶é—´/åœ°ç‚¹": "å‘¨æœ«ã€åŒ—äº¬èƒ¡åŒ",
            "æƒ…æ„ŸåŸºè°ƒ": "æ²»æ„ˆã€æç¬‘ã€æ„ŸåŠ¨",
            "æƒ³ä¼ è¾¾çš„ç‚¹": "äº«å—ç‹¬å¤„ã€è®°å½•ç”Ÿæ´»",
            "é£æ ¼è¦æ±‚": "æ–‡è‰ºæ¸…æ–°/çœŸå®è®°å½•"
        }
    }
}

# åŠ¨æ€ç”Ÿæˆè¾“å…¥è¡¨å•
with st.form("input_form"):
    st.subheader(f"âœï¸ å¡«å†™{content_type}ä¿¡æ¯")
    col1, col2 = st.columns(2)

    user_input = {}
    current_fields = form_config[content_type]["fields"]
    placeholders = form_config[content_type]["placeholders"]

    #å€ŸåŠ© enumerate() å‡½æ•°èƒ½å¤ŸåŒæ—¶è·å–ç´¢å¼• i å’Œå…ƒç´  fieldã€‚
    for i, field in enumerate(current_fields):
        if i % 2 == 0:   #i % 2: è¿™é‡Œçš„ % æ˜¯å–æ¨¡è¿ç®—ç¬¦ï¼Œå®ƒè¿”å› i é™¤ä»¥ 2 å¾—åˆ°çš„ä½™æ•°
            with col1:
                user_input[field] = st.text_area(
                    field,
                    placeholder=placeholders[field],
                    key=f"{content_type}_{field}",#å®ƒç¡®ä¿äº†åœ¨ä¸åŒå†…å®¹ç±»å‹ä¸‹ï¼ŒåŒåå­—æ®µä¹Ÿèƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ç¬¦ã€‚å½“ç”¨æˆ·åˆ‡æ¢å†…å®¹ç±»å‹ï¼ˆå¦‚ä» "äº§å“æ¨å¹¿" åˆ° "æ—…è¡Œæ”»ç•¥"ï¼‰æ—¶ï¼ŒStreamlit æ— æ³•åŒºåˆ†ä¸åŒç±»å‹ä¸‹çš„åŒåå­—æ®µï¼ˆå¦‚ "äº§å“åç§°" å’Œ "ç›®çš„åœ°"ï¼‰ï¼Œå¯¼è‡´è¾“å…¥å†…å®¹æ··ä¹±ï¼Œç”šè‡³å¯èƒ½å¼•å‘å¼‚å¸¸
                    height=100
                )
        else:
            with col2:
                user_input[field] = st.text_area(
                    field,
                    placeholder=placeholders[field],
                    key=f"{content_type}_{field}",
                    height=100
                )

    generate_button = st.form_submit_button("ç”Ÿæˆæ–‡æ¡ˆ", use_container_width=True)


#ç”Ÿæˆæ–‡æ¡ˆé€»è¾‘
if generate_button and not opneai_api_key:
    st.info("è¯·è¾“å…¥ä½ çš„Open AIå¯†é’¥ï¼ï¼ï¼")
    st.stop()
if generate_button:
    # å®šä¹‰æ¯ç§å†…å®¹ç±»å‹çš„å¿…å¡«å­—æ®µ
    required_fields = {
        "äº§å“æ¨å¹¿": ["äº§å“åç§°", "äº§å“ç±»åˆ«", "å–ç‚¹", "ç›®æ ‡äººç¾¤", "ç—›ç‚¹", "é£æ ¼è¦æ±‚"],
        "ç»éªŒæ•™ç¨‹": ["æ•™ç¨‹ä¸»é¢˜", "ç›®æ ‡äººç¾¤", "å·¥å…·/ææ–™", "æ­¥éª¤è¦ç‚¹", "å¸¸è§é—®é¢˜", "é£æ ¼è¦æ±‚"],
        "æ—…è¡Œæ”»ç•¥": ["ç›®çš„åœ°", "æ—…è¡Œå¤©æ•°", "å¿…å»æ™¯ç‚¹", "ç¾é£Ÿæ¨è", "å®ç”¨Tips", "é£æ ¼è¦æ±‚"],
        "ç”Ÿæ´»è®°å½•": ["ä¸»é¢˜å…³é”®è¯", "åœºæ™¯ç»†èŠ‚", "æ—¶é—´/åœ°ç‚¹", "æƒ…æ„ŸåŸºè°ƒ", "æƒ³ä¼ è¾¾çš„ç‚¹", "é£æ ¼è¦æ±‚"]
    }

    # æ£€æŸ¥æ‰€æœ‰å¿…å¡«å­—æ®µ
    missing_fields = []
    for field in required_fields[content_type]:
        if not user_input.get(field):
            missing_fields.append(field)

    # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if missing_fields:
        field_text = "ã€".join(missing_fields)#æŠŠåˆ—è¡¨è½¬æ¢æˆå­—ç¬¦ä¸²
        st.info(f"è¯·å¡«å†™ä»¥ä¸‹å¿…å¡«ä¿¡æ¯ï¼š{field_text}ï¼")
    else:
        with spinner("AIæ­£åœ¨åŠªåŠ›åˆ›ä½œä¸­ï¼Œè¯·ç¨ç­‰..."):
            response = generate_copywriting(opneai_api_key, content_type, user_input)

        #æ˜¾ç¤ºæ ‡é¢˜
        st.markdown("#### ğŸŒŸ ç”Ÿæˆçš„5ä¸ªæ ‡é¢˜")
        for i, title in enumerate(response.title):
            st.markdown(f"**æ ‡é¢˜{i+1}**ï¼š{title}")

        # æ˜¾ç¤ºæ­£æ–‡
        st.markdown("#### ğŸ“ å®Œæ•´æ­£æ–‡å†…å®¹")
        st.markdown(response.content)